<!DOCTYPE html>
<html>
<head>
  <script src="//code.jquery.com/jquery-3.3.1.min.js"></script>
  <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.6/socket.io.min.js"></script>
  <link rel="stylesheet" href="{{ url_for('static', filename='fonts/fonts.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/buttons.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/landing.css') }}"> 
</head>
<body>
  <div id='main_buttons'>
    <ul>
      <a onclick="goto_0()"><li><span>Waiting for user</span></li></a>
      <a onclick="goto_1()"><li><span>Landing page</span></li></a>
      <a onclick="goto_2()"><li><span>Searching database</span></li></a>
      <a onclick="goto_3()"><li><span>Search results</span></li></a>
      <a onclick="goto_4()"><li><span>Face search</span></li></a>
    </ul>
  </div>
  <div id='landing_container' style="">
    <table class="center">
      <tr>
        <td id='name_container'>
          <p id='name_text'>Hello Nico</p>
          <button id="begin" onclick="begin()" type="button" class='pink'>
              <div >
                <p class="center">Allow Aura to use my likeness</p>
              </div>
          </button>
        </td>
        <td>
          <div id='user-video' style="margin-left: 0px; width: 0px; transition: all .25s ease-out;">
            <img  class="webcam-img" src="{{ url_for('static', filename='images/user.jpg') }}"/>
          </div>
        </td>
      </tr>
    </table>
    <div id='logo'>
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 768 768" height="40%" width="40%" class="center" style='display:inline-block;'>
        <style>.a{stop-color:#1072ba;}.b{stop-color:#642e92;stop-opacity:1;}.c{stop-color:#93298e;}</style>
        <defs>
          <clipPath id="clippath_anim">
            <path d="m113.4 38.4c23.8 22.2 25 57.1 2.8 80.8-22.2 23.8-59.5 25-83.2 2.8C9.2 99.8 7.9 64.9 30.1 41.1 52.3 17.4 89.6 16.2 113.4 38.4ZM12.3 35.3C7 46.2 6 57.2 4.9 69.1 4.2 77.4 3.1 85.2 1.5 93.4 0.1 100.9-1 108.9 1.5 116.3c3.7 11.1 13.4 21.7 25.3 23.7 7.8 1.4 15.2 4 22.6 6.5 6.4 2.1 12.2 6.2 18.6 8.4 7.2 2.4 13.3 1.7 20.3-1.1 14.8-6 27.8-16.6 36.7-30 6-9.1 10.1-20.4 12.7-30.9 2-8 2.9-17 0.5-25-0.5-1.7-1.1-3.3-1.8-4.9C127 39.5 111.6 15.1 87.2 4.3 68.4-4 46.8 0.3 30.8 12.6 23 18.6 16.7 26.4 12.3 35.3">
              <animate  dur="1s" repeatCount="indefinite" attributeName="d" id="path_anim"
                values=""/>
            </path>
          </clipPath>
          <linearGradient gradientTransform="matrix(136.373,-49.4422,49.4422,136.373,-2.88337,104.3)" y2="0" x2="1.17487" y1="0" x1="-0.103708" gradientUnits="userSpaceOnUse" id="linear0">
            <stop id="stop-0" class="a" offset="-2" />
            <stop id="stop-1" class="b" offset="-1.61" />
            <stop id="stop-2" class="c" offset="-0.98" />
            <stop id="stop-3" class="b" offset="-0.39" />
            <stop id="stop-4" class="a" offset="0" />
            <stop id="stop-5" class="b" offset="0.61" />
            <stop id="stop-6" class="c" offset="0.98" />
          </linearGradient>
        </defs>
        <g transform="translate(-10.815422 614.04147)matrix(4.567124 0 0 4.567124 75.986409 -587.17343)">
          <path d="m56.1 64.9c-4.2 4.3-6.3 9.4-6.3 15.4 0 6.1 2.1 11.2 6.3 15.5 4.3 4.2 9.4 6.3 15.5 6.3 6.1 0 11.2-2.1 15.4-6.3 4.3-4.3 6.4-9.4 6.4-15.5 0-6-2.1-11.2-6.4-15.4-4.3-4.3-9.4-6.4-15.4-6.4-6.1 0-11.2 2.1-15.5 6.4zm42.3-11.4c7.4 7.4 11.1 16.4 11.1 26.8v30c0 2.2-0.8 4.1-2.4 5.6-1.6 1.6-3.4 2.4-5.6 2.4h-0.2c-2.2 0-4-0.8-5.6-2.4-1.6-1.5-2.4-3.4-2.4-5.6-5 5.3-12.3 8-21.8 8-10.5 0-19.4-3.7-26.8-11.1-7.4-7.4-11.1-16.4-11.1-26.8 0-10.5 3.7-19.4 11.1-26.8 7.4-7.4 16.4-11.1 26.8-11.1 10.5 0 19.4 3.7 26.8 11.1" fill="white"/>
          <g clip-path="url(#clippath_anim)">
            <path d="M-50.1 18.2 16.3 201.4 190.7 138.2 124.3-45Zm0 0" fill="url(#linear0)"/>
          </g>
          <path stroke="white" fill="transparent" id="svg_8">
            <animate  dur="10s" repeatCount="indefinite" attributeName="d" values="" id="path_anim"/>

          </path>
        </g>
      </svg>
      <button onclick="goto_1()" style="width: 300px; position: absolute; margin-top: 15%;" class='blue center'>
          <div>
            <p class="center">Touch wristband to start</p>
          </div>
      </button>
    </div>
  </div>
  <table id='globe_container'>
    <tr>
      <td>
        <ul id="search-list">
          <li>
            Searching public information leaks such as Cambridge Analytica (2016)
          </li>
          <li>
            Searching US biometric database (Rolled out in May 2020)
          </li>
          <li>
            Searching YITU facial payment database (In use 2016 to present)
          </li>
          <li>
            Searching 570 million CCTV camera database (In use 2016 to present)
          </li>
          <li>
            <button class="blue center" style="width:150px;" onclick="goto_3()"><div ><p class="center">Continue</p></div></button>
          </li>
        </ul>
      </td>
      <td>
        <div id="currentInfo" style="display:none">
          <span id="year1" class="year">1990</span>
          <span id="year2" class="year">1995</span>
          <span id="year3" class="year">2000</span>
          <span id="year4" class="year">2000</span>
        </div>
        <div id='globe'>
        </div>
      </td>
    </tr>
  </table>
  <div id="credit_score_container">
    <div id=credit_score_grid>
      <p class="credit_score_title">Your Social Credit Score</p>
      <div class="credit_score">
        <div class="credit_score_mask">
          <div class="credit_score_bg">
            <div class="credit_score_segment" style="--bg:var(--aura-red); --value:68"></div>
            <div class="credit_score_segment" style="--bg:var(--aura-yellow); --value:68; --offset:70"></div>
            <div class="credit_score_segment" style="--bg:var(--aura-green); --value:40; --offset:140"></div>
          </div>
          <div class="credit_score_marker"></div>
          <div class="credit_score_label"></div>
        </div>
      </div>
      <p class="credit_score_subtitle">Contributing Factors. Press a factor for more information</p>
        <div class="factor" style="--bg:var(--aura-green);"  onclick="show_factor_overlay(0)"><div><p>Purchases and payments</p><h1 id="payment_total">$320</h1></div></div>
        <div class="factor" style="--bg:var(--aura-yellow);" onclick="show_factor_overlay(1)"><div><p>Travel</p><h1 id="travel_total">4</h1></div></div>
        <div class="factor" style="--bg:var(--aura-green);"  onclick="show_factor_overlay(2)"><div><p>Verified social networks</p><h1 id="social_total">3</h1></div></div>
      <div class="credit_score_content">
        <p>Based on this score you are able to travel freely, attend private schools, and apply for loans</p>
      </div>
      <div style="grid-area: button;"><button class="blue center" style="width:150px;" onclick="goto_4()"><div ><p class="center">Continue</p></div></button></div>
    </div>

    <div class="factor overlay">
      <div>
        <h1>Purchases</h1>
        <p>Payments to businesses or individuals with poor social credit scores may result in lowering your score. Always encourage businesses and friends to be honest about their credit scores. Report false credit scores at <u>https://www.dhs.gov/how-do-i/report-suspicious-activity</u></p>
        <ul id="payment_list">
            <li><span class="credit-score-dot green"></span>You paid Jonas Wisser $18.00 using Venmo on July 7 2019</li>
            <li><span class="credit-score-dot green"></span>You paid Anna Nelson $26.00 using Venmo on June 15 2019</li>
            <li><span class="credit-score-dot yellow"></span>Receipt for $5.00 at Commonplace Coffee Co on Sep 19 2017</li>
            <li><span class="credit-score-dot red"></span>You paid Micaela Corn $50.00 using Venmo on Sep 19 2017</li>
            <li><span class="credit-score-dot yellow"></span>Receipt for $24.91 at Five Points Artisan Bakeshop on Sep 16 2017</li>
            <li><span class="credit-score-dot green"></span>Receipt for $6.42 at Joes dog house on Sep 15 2017</li>
            <li><span class="credit-score-dot yellow"></span>Receipt for $4.05 at Artisan Cafe on Aug 25 2017</li>
            <li><span class="credit-score-dot red"></span>Receipt for $9.84 at New Mexican Cuisine on Aug 15 2017</li>
            <li><span class="credit-score-dot green"></span>Receipt for $12.55 at Tazikis Mediterranean Cafe on Aug 9 2017</li>
        </ul>
      </div>
      <button class="exit" style="width:60px;" onclick="close_factor_overlay(0)"><div ><p class="center">X</p></div></button>
    </div>

    <div class="factor overlay">
      <div>
        <h1>Instances of foreign travel</h1>
        <p>Travelling excessively can affect your social credit in multiple ways. Trustworthy citizens are hard workers and do not travel frivolously. If your job requires excessive travel, your business must be registered with the Department of Homeland Security. In addition, the more places you go the more likely it is that facial recognition mistakes you for someone else.</p>
        <ul id="travel_list">
            <li><span class="credit-score-dot yellow"></span>Mexico City, MX on July 7 2019</li>
            <li><span class="credit-score-dot yellow"></span>Atlanta, GA on on Sep 19 2017</li>
            <li><span class="credit-score-dot yellow"></span>Quito, EC on Aug 25 2017</li>
            <li><span class="credit-score-dot yellow"></span>Lima, PE on Aug 9 2017</li>
        </ul>
      </div>
      <button class="exit" style="width:60px;" onclick="close_factor_overlay(1)"><div ><p class="center">X</p></div></button>
    </div>

    <div class="factor overlay">
      <div>
        <h1>Verified social networks</h1>
        <p>If you are a part of a social network, it is highly reccomended to change your preferences to allow government oversight. Much like a normal credit score and credit cards, the more consistent and responsible your usage is, the better your social credit score becomes.</p>
        <ul id="social_network_list">
            <li><span class="credit-score-dot green"></span>Facebook</li>
            <li><span class="credit-score-dot green"></span>Instagram</li>
            <li><span class="credit-score-dot green"></span>LinkedIn</li>
        </ul>
      </div>
      <button class="exit" style="width:60px;" onclick="close_factor_overlay(2)"><div ><p class="center">X</p></div></button>
    </div>
  </div>
  <div id='face_search_container'>
    <div id="explanation_overlay">
      <p class="center">Aura's facial recognition technology is state of the art, yet the possibility remains that our facial recognition software may confuse you with someone else. We believe that although this possibility is remote, we can leverage our technology to help you put your best face forward. On the next screen, we will show you close matches to your face in real time, as well as the effect of facial misrecognition on your perceived social credit score. Try to find a facial posture that presents you safely as an honest citizen. Keep in mind that what looks similar to a human may not look similar to an algorithm.</p>
      <button onclick="hide_explanation()" style="width: 100px; position: absolute; margin-top: 15%;" class='blue center'>
          <div>
            <p class="center">Begin</p>
          </div>
      </button>
    </div>
    <div style="grid-row:1/3; height: 83%; width:80%;" >
      <img  class="webcam-img"src="{{ url_for('static', filename='images/user.jpg') }}" style="width:80%;"/>
      <p><span class="true credit-score-dot green"></span>True social credit score</p>
      <p><span class="fake credit-score-dot"></span>Perceived social credit score</p>
      <button onclick="goto_0()" style="width: 300px; margin-top: 5%;" class='blue'>
          <div>
            <p class="center">Finish and get results</p>
          </div>
      </button>
    </div>
    <div class='result' style="align-self:end;">
      <img  id="result-img-A" src="{{ url_for('static', filename='images/000001.png') }}"/>
      <span class="credit-score-dot-img"></span>
    </div>
    <div class='result' style="align-self:end;">
      <img  id="result-img-B" src="{{ url_for('static', filename='images/000002.png') }}"/>
      <span class="credit-score-dot-img"></span>
    </div>
    <div class='result' style="align-self:baseline;">
      <img  id="result-img-C" src="{{ url_for('static', filename='images/000003.png') }}"/>
      <span class="credit-score-dot-img"></span>
    </div>
    <div class='result' style="align-self:baseline;">
      <img  id="result-img-D" src="{{ url_for('static', filename='images/000000.png') }}"/>
      <span class="credit-score-dot-img"></span>
    </div>
    <div class='result' style="align-self:baseline; display:none;">
      <img  id="result-img-E" src="{{ url_for('static', filename='images/000001.png') }}"/>
      <span class="credit-score-dot-img"></span>
    </div>
    <div class='result' style="align-self:baseline; display:none;">
      <img  id="result-img-F" src="{{ url_for('static', filename='images/000002.png') }}"/>
      <span class="credit-score-dot-img"></span>
    </div>
  </div>

  <script type="text/javascript" src="{{ url_for('static', filename='webgl-globe/globe/third-party/Detector.js') }}"></script>
  <script type="text/javascript" src="{{ url_for('static', filename='webgl-globe/globe/third-party/three.min.js') }}"></script>
  <script type="text/javascript" src="{{ url_for('static', filename='webgl-globe/globe/third-party/Tween.js') }}"></script>
  <script type="text/javascript" src="{{ url_for('static', filename='webgl-globe/globe/globe.js') }}"></script>
  <script type="text/javascript" src="{{ url_for('static', filename='js/logo_wobble.js') }}"></script>
  <script type="text/javascript">
        document.getElementById('path_anim').setAttribute('values', make_wobble_anim(80,73,80,70,5,20));
        document.getElementById('path_anim').setAttribute('dur', '10s');
  </script>
  <script type="text/javascript"> 
  // GLOBE STUFF 
    if(!Detector.webgl){
      Detector.addGetWebGLMessage();
    } else {
      var globeContainer = document.getElementById('globe');
      var globe = new DAT.Globe(globeContainer);

      console.log(globe);

      var years = ['1','2','3', '4'];

      console.log(globe);
      var i, tweens = [];
      
      var settime = function(globe, t) {
        return function() {
          new TWEEN.Tween(globe).to({time: t/years.length},500).easing(TWEEN.Easing.Cubic.EaseOut).start();
          var y = document.getElementById('year'+years[t]);
          // if (y.getAttribute('class') === 'year active') {
          //   return;
          // }
          var yy = document.getElementsByClassName('year');
          for(i=0; i<yy.length; i++) {
            yy[i].setAttribute('class','year');
          }
          // y.setAttribute('class', 'year active');
        };
      };
      
      for(var i = 0; i<years.length; i++) {
        var y = document.getElementById('year'+years[i]);
        y.addEventListener('mouseover', settime(globe,i), false);
      }

      var xhr;
      TWEEN.start();      
      xhr = new XMLHttpRequest();
      xhr.open('GET', "{{ url_for('static', filename='webgl-globe/globe/population909500.json') }}", true);

      xhr.onreadystatechange = function(e) {
        if (xhr.readyState === 4) {
          if (xhr.status === 200) {
            var data = JSON.parse(xhr.responseText);
            window.data = data;
            for (i=0;i<data.length;i++) {
              globe.addData(data[i][1], {format: 'magnitude', name: data[i][0], animated: true});
            }
            globe.createPoints();
            settime(globe,1)();
            globe.animate();
            // document.body.style.backgroundImage = 'none'; // remove loading
          }
        }
      };
      xhr.send(null);
    }
  </script>

  <script>
  // PUSHERMAN STUFF
    // Placeholder for socketIO
    function get_user_data(token) {}

    window.addEventListener('userLogin', (event) => {
        // userLogin triggers when a user has logged in. The event object
        // contains event.detail.tapData which contains information about the user who has
        // just tapped in and event.detail.users contains an object with all currently
        // logged in users.
        const tapData = event.detail.tapData;
        console.log("Handling login for:", tapData.username);
        hide_logo();
        const nameText = document.getElementById('name_text');
        console.log(tapData);
        nameText.textContent = "Hello " + tapData.meta.first_name;
        get_user_data(tapData.token);
    })

    window.addEventListener('userLogout', (event) => {
        // userLogout triggers when a user has logged out (ie: tapped twice). The event object
        // contains event.detail.tapData which contains information about the user who has
        // just logged out and event.detail.users contains an object with all currently
        // logged in users.
        const tapData = event.detail.tapData;
        console.log("Handling logout for:", tapData.username);
        goto_0();
        // const block = document.getElementById('login-info');
        // block.textContent = JSON.stringify(tapData, null, 2);
        // hljs.highlightBlock(block);
        // block.classList.add('error');
    })

    function initializeLoginEvent(appName, handleLogout=true, timeout=0) {
        // hostname should be staging.projectamelia.ai for testing
        // and projectamelia.ai for production. Since this page is being
        // hosted on the server, we can just use window.location.hostname to
        // automatically pick the right one
        // const hostname = window.location.hostname;
        const hostname = 'staging.projectamelia.ai';
        const ws = new WebSocket(`wss://${hostname}/pusherman/companions/login/websocket?app=${appName}`);

        let users = {};
        ws.onmessage = (event) => {
            const tapData = JSON.parse(event.data);
            const { username, token } = tapData;
            var tapEvent;
            const eventConfig = {
                detail: {tapData, users, appName},
                bubbles: true,
            };
            if (!handleLogout) {
                for (var u in users) {
                    delete users[u];
                }
            }
            if (username in users) {
                tapEvent = new CustomEvent('userLogout', eventConfig);
                delete users[username]
            } else {
                tapEvent = new CustomEvent('userLogin', eventConfig);
                users[username] = tapData;
            }
            window.dispatchEvent(tapEvent);
        };

        ws.onclose = (event) => {
            timeout = Math.min((timeout + 1000) * 2, 30000);
            console.log("Trying to reconnect to login websocket in:", timeout);
            setTimeout(
                () => {
                    console.log("Attempting reconnect to login websocket");
                    initializeLoginEvent(appName, handleLogout, timeout);
                },
                timeout
            )
        }

        ws.onopen = async (event) => {
            timeout = 0;
            const eventConfig = {
                detail: {users, appName},
                bubbles: true,
            };
        };
    }

    initializeLoginEvent('social_calculator');    
  // BUTTON STUFF
    function reset_1() {
      document.getElementById('user-video').style.marginLeft = "0px";
      document.getElementById('user-video').style.width = "0px";
      document.getElementById('begin').classList.add('pink');
      document.getElementById('begin').classList.remove('blue');
      document.getElementById('begin').children[0].children[0].innerHTML='Allow Aura to use my likeness';
      document.getElementById('begin').onclick = begin
    }

    function reset_2() {
      settime(globe,1)();
      var children = document.getElementById('search-list').children;
      for (var i = 0; i < children.length; i++) {
        children[i].classList.remove("shown");
        children[i].style.transition = "none";
      } 
    }

    // Placeholders for socketIO
    function search() {}
    function stop_search() {}

    function reset_3() {
      set_credit_score(300,0);
    }

    var credit_score = 300;
    function set_credit_score(score, idx) {
      credit_scores = document.getElementsByClassName('credit_score');
      credit_scores[idx].style.setProperty('--score', score); 
    }

    function goto_0() {
      var transition = document.getElementById('landing_container').style.transition;
      document.getElementById('landing_container').style.transition = "none";
      document.getElementById('landing_container').style.marginTop="-0vh";
      document.getElementById('landing_container').style.transition = transition;
      document.getElementById('logo').style.opacity = "1";
      document.getElementById('logo').style.display = "block";
      reset_3();
      reset_2();
      reset_1();
      stop_search();
    }

    function hide_logo() {
      document.getElementById('logo').style.opacity = "0";
      window.setTimeout(function() {
        document.getElementById('logo').style.display = "none";
      }, 1000);
    }

    function goto_1() {
      document.getElementById('landing_container').style.marginTop="-0vh";
      hide_logo();
      reset_3();
      reset_2();
      reset_1();
      stop_search();
    }

    function goto_2() {
      document.getElementById('landing_container').style.marginTop="-100vh";
      hide_logo();
      var children = document.getElementById('search-list').children;
      settime(globe, children.length)()
      for (var i = 0; i < children.length; i++) {
        children[i].classList.add("shown");
        children[i].style.transition = "all .25s ease-in";
        children[i].style.transitionDelay = 1+i*2 +"s";
        if (i == children.length-1)
          break;
        window.setTimeout(settime(globe, i+1), (1+i*2) * 1000);
      }
      stop_search();
      // window.setTimeout(goto_3, children.length * 2500 );
    }

    function goto_3() {
      window.setTimeout(set_credit_score, credit_score, 755,0);
      document.getElementById('landing_container').style.marginTop="-200vh";
      hide_logo();
      reset_1();
      reset_3();
      stop_search();
      document.getElementById('explanation_overlay').style.opacity = 1;
      document.getElementById('explanation_overlay').style.display = "block";
    }

    function goto_4() {
      document.getElementById('landing_container').style.marginTop="-300vh";
      search();
      hide_logo();
      reset_1();
      reset_2();
    }

    function hide_explanation() {
      document.getElementById('explanation_overlay').style.opacity = 0;
      window.setTimeout(function() {
        document.getElementById('explanation_overlay').style.display = "none";
      }, 1000);
    }

    function begin() {
      document.getElementById('user-video').style.marginLeft = "60px";
      document.getElementById('user-video').style.display = "inline-block";
      document.getElementById('user-video').style.width = "600px";
      document.getElementById('begin').classList.remove('pink');
      document.getElementById('begin').classList.add('blue');
      document.getElementById('begin').children[0].children[0].innerHTML='Search global database';
      document.getElementById('begin').onclick = goto_2
    }

    function hexToRgb(hex) {
      // Expand shorthand form (e.g. "03F") to full form (e.g. "0033FF")
      var shorthandRegex = /^#?([a-f\d])([a-f\d])([a-f\d])$/i;
      hex = hex.replace(shorthandRegex, function(m, r, g, b) {
        return r + r + g + g + b + b;
      });

      var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
      return result ? {
        r: parseInt(result[1], 16),
        g: parseInt(result[2], 16),
        b: parseInt(result[3], 16)
      } : null;
    }

    function rgbToHex(r, g, b) {
      return "#" + componentToHex(r) + componentToHex(g) + componentToHex(b);
    }


    function red_to_green(amount) {
      var green  = hexToRgb('#d2d75a');
      var yellow = hexToRgb('#fec65f');
      var red    = hexToRgb('#e46560');
      ratio = amount * 2;
      if (ratio <= 0)
        return 'rgb(' + red.r + ',' + red.g + ',' + red.b + ')'
      else if (ratio <= 1) {
        return 'rgb(' + (red.r * (1-ratio) + yellow.r * ratio) + ',' +
                        (red.g * (1-ratio) + yellow.g * ratio) + ',' +
                        (red.b * (1-ratio) + yellow.b * ratio) + ')'
      }
      else if (ratio <= 2) {
        return 'rgb(' + (yellow.r * (2-ratio) + green.r * (ratio - 1)) + ',' +
                        (yellow.g * (2-ratio) + green.g * (ratio - 1)) + ',' +
                        (yellow.b * (2-ratio) + green.b * (ratio - 1)) + ')'
      } else {
        return 'rgb(' + green.r + ',' + green.g + ',' + green.b + ')'
      }
    }

    function close_factor_overlay(id){
      document.getElementsByClassName('factor overlay')[id].style.opacity = 0;
      window.setTimeout(function() {
        document.getElementsByClassName('factor overlay')[id].style.display = "none";
      }, 500);
    }

    function show_factor_overlay(id){
      document.getElementsByClassName('factor overlay')[id].style.display = "block";
      window.setTimeout(function() {
        document.getElementsByClassName('factor overlay')[id].style.opacity = 1;
      }, 50);
    }
  // SOCKET STUFF
    $(document).ready(function(){
      //connect to the socket server.
      var socket = io.connect('http://' + document.domain + ':' + location.port + '/test');
      socket.on("image", function(info) {
        if (info.image){
          // Obtain a blob: URL for the image data.
          var arrayBufferView = new Uint8Array( info.buffer );
          var blob = new Blob( [ arrayBufferView ], { type: "image/jpeg" } );
          var urlCreator = window.URL || window.webkitURL;
          var imageUrl = urlCreator.createObjectURL( blob );
          var imgs = document.getElementsByClassName('webcam-img');
          var i
          for(i=0; i < imgs.length; i++){
            imgs[i].src = imageUrl;
          }
        }
      });

      // Fill placeholder functions
      get_user_data = function get_user_data(token) { socket.emit('get_user_data', { token: token }); };
      stop_search = function stop_search() { socket.emit('stop_search', ''); };
      search = function search() { socket.emit('search', ''); };

      function paddy(num, padlen, padchar) {
          var pad_char = typeof padchar !== 'undefined' ? padchar : '0';
          var pad = new Array(1 + padlen).join(pad_char);
          return (pad + num).slice(-pad.length);
      }

      function make_svg_wobble(n_points, center_x, center_y, radius=1, noise=0) {
        var svg_string = "";
        var step = 1 / n_points * Math.PI * 2;
        var handle_len = radius / n_points * 0.552 * 4;
        var last_x = 0;
        var last_y = 0;
        for(var i=0; i < n_points + 1; i++){
          var x  = -Math.cos(i * step) * radius + center_x;
          var y  =  Math.sin(i * step) * radius + center_y;
          var x1 =  Math.sin((i-1) * step) * handle_len + last_x;
          var y1 =  Math.cos((i-1) * step) * handle_len + last_y; 
          var x2 = -Math.sin(i * step) * handle_len + x;
          var y2 = -Math.cos(i * step) * handle_len + y;
          var last_x  = x;
          var last_y  = y;
          if(i==0) {
            svg_string +=   'M ' + x + ' ' + y;
          } else {
            svg_string += ', C ' + x1 + ' ' + y1 + ', ' + x2 + ' ' + y2 + ', ' + x + ' ' + y;
          }
        }
        return svg_string + 'Z';
      }

      socket.on('searchResult', function(msg) {
          // var pad = "000000";
          // var a_file =  '/static/images/' + paddy(Math.floor(msg.A / 1000)*1000, 6, '0') +  '/' + paddy(msg.A, 6, '0') + '.png'; 
          // var b_file =  '/static/images/' + paddy(Math.floor(msg.B / 1000)*1000, 6, '0') +  '/' + paddy(msg.B, 6, '0') + '.png'; 
          // var c_file =  '/static/images/' + paddy(Math.floor(msg.C / 1000)*1000, 6, '0') +  '/' + paddy(msg.C, 6, '0') + '.png'; 
          // var d_file =  '/static/images/' + paddy(Math.floor(msg.D / 1000)*1000, 6, '0') +  '/' + paddy(msg.D, 6, '0') + '.png'; 
          // var e_file =  '/static/images/' + paddy(Math.floor(msg.E / 1000)*1000, 6, '0') +  '/' + paddy(msg.E, 6, '0') + '.png';
          // var f_file =  '/static/images/' + paddy(Math.floor(msg.F / 1000)*1000, 6, '0') +  '/' + paddy(msg.F, 6, '0') + '.png';
          document.getElementById('result-img-A').src = msg.A;
          document.getElementById('result-img-B').src = msg.B;
          document.getElementById('result-img-C').src = msg.C;
          document.getElementById('result-img-D').src = msg.D;
          document.getElementById('result-img-A').style.opacity = 1.0;
          document.getElementById('result-img-B').style.opacity = 0.7;
          document.getElementById('result-img-C').style.opacity = 0.4;
          document.getElementById('result-img-D').style.opacity = 0.2;
          // document.getElementById('result-img-A').parentElement.src = msg.A;
          // document.getElementById('result-img-B').parentElement.src = msg.B;
          // document.getElementById('result-img-C').parentElement.src = msg.C;
          // document.getElementById('result-img-D').parentElement.src = msg.D;
          document.getElementById('result-img-A').nextSibling.nextSibling.style.backgroundColor = red_to_green(parseFloat(msg.Acred));
          document.getElementById('result-img-B').nextSibling.nextSibling.style.backgroundColor = red_to_green(parseFloat(msg.Bcred));
          document.getElementById('result-img-C').nextSibling.nextSibling.style.backgroundColor = red_to_green(parseFloat(msg.Ccred));
          document.getElementById('result-img-D').nextSibling.nextSibling.style.backgroundColor = red_to_green(parseFloat(msg.Dcred));

          var average_score = (parseFloat(msg.Acred) + parseFloat(msg.Bcred) * 0.5 + parseFloat(msg.Ccred) * 0.25 + parseFloat(msg.Dcred) * 0.125 ) / 1.875;

          document.getElementsByClassName('fake credit-score-dot')[0].style.background = red_to_green(average_score);

          var user_score = 755;

          document.getElementsByClassName('true credit-score-dot')[0].style.background = red_to_green((user_score - 300) / 500);
          console.log(user_score, average_score)
          var difference = Math.round((average_score * 500 + 300) - user_score);
          if (difference >= 0) difference = "+"


          var text = document.getElementsByClassName("fake credit-score-dot")[0].parentElement.innerHTML;
          text = text.slice(0, text.indexOf('</span>')+7);
          document.getElementsByClassName("fake credit-score-dot")[0].parentElement.innerHTML = text + "Perceived credit score (" + difference + ")";


          // document.getElementById('result-img-E').src = msg.E;
          // document.getElementById('result-img-F').src = msg.F;
          // console.log([msg.A, msg.B, msg.C, msg.D, msg.E, msg.F]);
          // console.log([msg.Adist, msg.Bdist, msg.Cdist, msg.Ddist, msg.Edist, msg.Fdist]);
          // console.log([msg.Acred, msg.Bcred, msg.Ccred, msg.Dcred, msg.Ecred, msg.Fcred]);
          // document.getElementById('layout').elem.classList.add('show');
      });

      // Hashing function
      String.prototype.hashToFloat = function() {
        var hash = 0, i, chr, float;
        if (this.length === 0) return hash;
        for (i = 0; i < this.length; i++) {
          chr   = this.charCodeAt(i);
          hash  = ((hash << 5) - hash) + chr;
        }
        float = Math.sin(hash) * 10000;
        return float - Math.floor(float);
        return hash;
      };

      function clearDiv(id){
        var elem = document.getElementById(id);
          while(elem.childElementCount > 0){
            elem.removeChild(elem.firstChild); 
          }
      }

      function fillPaymentList(payments){
        clearDiv('payment_list')
        var totalAmount = 0;
        var averageScore = 0;
        // console.log(payments);
        var name = "";
        var preposition = "";
        var elem = document.getElementById('payment_list');
        for(var i=0; i < payments.length; i++) {
        // for(var i=0; i < 10; i++) {
          if(payments[i].from != "me")
          {
            name = payments[i].from;
            preposition = "to";
          }
          else if(payments[i].to != "me")
          {
            name = payments[i].to;
            preposition = "from";
          }
          var paymentItem = document.createElement('li');
          var paymentDot = document.createElement('span');
          paymentDot.classList.add('credit-score-dot');
          averageScore += name.hashToFloat();
          totalAmount += payments[i].amount;
          var hash = Math.round(name.hashToFloat() * 2.999 - 0.5);
          paymentDot.classList.add(['red','yellow','green'][hash]);
          paymentItem.appendChild(paymentDot);
          var text = "$" + payments[i].amount + " " + preposition + " " + name;
          paymentItem.appendChild(document.createTextNode(text));
          elem.appendChild(paymentItem);
        }
        var scoreColor = ['red','yellow','green'][Math.round(averageScore / payments.length  * 2.999 - 0.5)];
        document.getElementById('payment_total').textContent = "$" + Math.round(totalAmount);
        document.getElementById('payment_total').parentElement.parentElement.style.setProperty('--bg', 'var(--aura-' + scoreColor + ')');
        return averageScore / payments.length;
      }

      function RNG(seed) {
        // LCG using GCC's constants
        this.m = 0x80000000; // 2**31;
        this.a = 1103515245;
        this.c = 12345;

        this.state = seed ? seed : Math.floor(Math.random() * (this.m - 1));
      }
      RNG.prototype.nextInt = function() {
        this.state = (this.a * this.state + this.c) % this.m;
        return this.state;
      }
      RNG.prototype.nextFloat = function() {
        // returns in range [0,1]
        return this.nextInt() / (this.m - 1);
      }
      RNG.prototype.nextRange = function(start, end) {
        // returns in range [start, end): including start, excluding end
        // can't modulu nextInt because of weak randomness in lower bits
        var rangeSize = end - start;
        var randomUnder1 = this.nextInt() / this.m;
        return start + Math.floor(randomUnder1 * rangeSize);
      }
      RNG.prototype.choice = function(array) {
        return array[this.nextRange(0, array.length)];
      }

      var random_names = ['Liam','Noah','William','James','Logan','Benjamin','Mason','Elijah','Oliver','Jacob','Lucas','Michael','Alexander','Ethan','Daniel','Matthew','Aiden','Henry','Joseph','Jackson','Samuel','Sebastian','David','Carter','Wyatt','Jayden','John','Owen','Dylan','Luke','Gabriel','Anthony','Isaac','Grayson','Jack','Julian','Levi','Christopher','Joshua','Andrew','Lincoln','Mateo','Ryan','Jaxon','Nathan','Aaron','Isaiah','Thomas','Charles','Caleb','Josiah','Christian','Hunter','Eli','Jonathan','Connor','Landon','Adrian','Asher','Cameron','Leo','Theodore','Jeremiah','Hudson','Robert','Easton','Nolan','Nicholas','Ezra','Colton','Angel','Brayden','Jordan','Dominic','Austin','Ian','Adam','Elias','Jaxson','Greyson','Jose','Ezekiel','Carson','Evan','Maverick','Bryson','Jace','Cooper','Xavier','Parker','Roman','Jason','Santiago','Chase','Sawyer','Gavin','Leonardo','Kayden','Ayden','Jameson'];

      var random_last_names = ['Hamilton', 'Barr', 'Shepard', 'Hatfield', 'Mcmahon', 'Rich', 'Cox', 'Faulkner', 'Payne', 'Miller', 'Choi', 'Bender', 'Black', 'Rose', 'Ross', 'Hayes', 'Lowe', 'Deleon', 'Humphrey', 'Shah', 'Sanchez', 'Blanchard', 'Andrade', 'Gilmore', 'Haney', 'David', 'Ray', 'Estes', 'Gilbert', 'Landry', 'Harvey', 'Hooper', 'Mccarty', 'Ellis', 'Rowe', 'Dickson', 'Moyer', 'Holder', 'Cantrell', 'House', 'Sellers', 'Hoffman', 'Orozco', 'Wagner', 'Hahn', 'Jensen', 'Mcintyre', 'Phelps', 'Morton', 'Carr', 'Key', 'Little', 'Hall', 'Blackburn', 'Caldwell', 'Burns', 'Bishop', 'Cooke', 'Savage', 'Blake', 'Pope', 'Nash', 'Walter', 'Kirk', 'Braun', 'Harrell', 'Santiago', 'Knight', 'Huff', 'Mejia', 'Glenn', 'Burnett', 'Harding', 'Trujillo', 'Conner', 'Graves', 'Parks', 'Maynard', 'Pugh', 'Brandt', 'Gonzales', 'Harmon', 'Mcguire', 'Kaufman', 'Dennis', 'York', 'Bray', 'Castro', 'Bartlett', 'Khan', 'Singh', 'Mckinney', 'Moon', 'Suarez', 'Le', 'Sherman', 'Williams', 'Joyce', 'Obrien', 'Spencer', 'Rollins', 'Walls', 'Gonzalez', 'Townsend', 'French', 'Clay', 'Hester', 'Wilkinson', 'Willis', 'Hunt', 'Brown', 'Campos', 'Ferrell', 'Weaver', 'Dillon', 'Lucero', 'Spears', 'Stephenson', 'Baxter', 'Lambert', 'Barajas', 'Gates', 'Vega', 'Bowman', 'Clements', 'Rivas', 'Bradley', 'Mendez', 'Sanders', 'Stokes', 'Ibarra', 'Russo', 'Vargas', 'Lozano', 'Bean', 'Sampson', 'Haynes', 'Richmond', 'Holden', 'Rubio', 'Hopkins', 'Nicholson', 'Cervantes', 'Lynch', 'Gross', 'Stark', 'Morris', 'Greene', 'Rosario', 'Cisneros', 'Williamson', 'Benjamin', 'Woodard', 'Love', 'Schneider', 'Avery', 'Frost', 'Gomez', 'West', 'Morrison', 'Heath', 'Whitney', 'Woodward', 'Cortez', 'Travis', 'Guzman', 'Terrell', 'Valdez', 'Davies', 'Hoover', 'Sandoval', 'Finley', 'Walsh', 'Cooper', 'Clayton', 'Fields', 'Duke', 'Atkins', 'Briggs', 'Beard', 'Douglas', 'Mcmillan', 'Goodman', 'Price', 'Howe', 'Arroyo', 'Robles', 'Gutierrez', 'Levine', 'Cordova', 'Powers', 'Harper', 'Acosta', 'Dyer', 'Chaney', 'Gillespie', 'Mullins', 'Mcpherson', 'Winters', 'Stone']

      function fake_data(name, type, text_options, bias_min, bias_max) {
        clearDiv(type + '_list')
        var total_score = 0;
        var rng = new RNG(Math.round((type + name).hashToFloat() * 10000));
        var n_elements = rng.nextInt() % 50 + 10;
        var elem = document.getElementById(type + '_list');
        var bias = 2 * rng.nextFloat();
        if(bias < 1) 
        {
          bias = bias * (1-bias_min) + bias_min;
        } else {
          bias = (bias - 1) * (bias_max - 1) + 1;
        }
        console.log(bias);
        for(var i=0; i<n_elements; i++)
        {
          var listElem = document.createElement('li');
          var scoreDot = document.createElement('span');
          scoreDot.classList.add('credit-score-dot');
          var score = Math.pow(rng.nextFloat(), bias);
          total_score += score;
          scoreDot.classList.add(['red','yellow','green'][Math.floor(score * 3)]);
          listElem.appendChild(scoreDot);
          var text = document.createElement('p');
          text.appendChild(document.createTextNode(text_options[Math.floor(score * text_options.length)]));
          var nameText = document.createElement('span');
          nameText.appendChild(document.createTextNode(rng.choice(random_names) + ' ' + rng.choice(random_last_names)));
          nameText.classList.add('blurry-text');
          text.appendChild(nameText)
          listElem.appendChild(text);
          elem.appendChild(listElem);
        }
        return [total_score, n_elements];
      }

      function fakePayments(name) {
        var text_options = ['Payment from ', 'Payment to ', 'Purchase from ', 'Payment from ', 'Payment to ', 'Purchase from ', 'Payment from ', 'Payment to ', 'Purchase from '];
        var retval = fake_data(name, 'payment', text_options, 0.2, 4);
        var averageScore = retval[0] / retval[1];
        console.log(retval);
        var scoreColor = ['red','yellow','green'][Math.floor(averageScore * 3)];
        document.getElementById('payment_total').parentElement.parentElement.style.setProperty('--bg', 'var(--aura-' + scoreColor + ')');
        document.getElementById('payment_total').textContent = ['Poor','Average', 'Excellent'][Math.floor(averageScore * 3)];
        return averageScore
      }

      function fakeFlights(name) {
        var text_options = ['Unauthorized travel to ', 'Authorized travel to '];
        var retval = fake_data(name, 'travel', text_options, 0.2, 4);
        var averageScore = retval[0] / retval[1];
        var scoreColor = ['red','yellow','green'][Math.floor(averageScore * 3)];
        document.getElementById('travel_total').parentElement.parentElement.style.setProperty('--bg', 'var(--aura-' + scoreColor + ')');
        document.getElementById('travel_total').textContent = ['Poor','Average', 'Excellent'][Math.floor(averageScore * 3)];
        return averageScore
      }

      function fillFlights(flights){

      }

      function fillSocialNetworks(networks){

      }

      socket.on('user_data', function(msg) {
        data = JSON.parse(msg.json);
        var travelScore, paymentScore, socialScore = 0;
        if(data.payments.length == 0) {
          paymentScore = fakePayments(data.name);
        } else {
          paymentScore = fillPaymentList(data.payments);
        }
        travelScore = fakeFlights(data.name);
        socialScore = 1.0;
        credit_score = Math.round(850 * (travelScore + paymentScore + socialScore) / 3.0);
        console.log(data.flights);
        console.log(data.venmo_snippets);
        console.log(data.squarecash_snippets);
      });

    });
  </script>
</body>
</html>